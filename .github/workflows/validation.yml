name: Code Validation

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main

jobs:
  python-validation:
    name: Python Code Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort mypy
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f src/requirements.txt ]; then pip install -r src/requirements.txt; fi

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Check for other issues but don't fail
          flake8 src/ --count --max-complexity=10 --max-line-length=120 --statistics --exit-zero

      - name: Check code formatting with black
        run: |
          black --check --diff src/ || echo "⚠️ Black formatting issues found (non-blocking)"
        continue-on-error: true

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff src/ || echo "⚠️ Import sorting issues found (non-blocking)"
        continue-on-error: true

      - name: Lint with pylint
        run: |
          pylint src/ --exit-zero --output-format=text --reports=yes
        continue-on-error: true

      - name: Type checking with mypy
        run: |
          mypy src/ --ignore-missing-imports --no-strict-optional --exit-zero
        continue-on-error: true

      - name: Run Python tests
        run: |
          if [ -f src/requirements.txt ]; then
            pip install pytest pytest-cov
            if [ -d tests ]; then
              pytest tests/ --cov=src --cov-report=xml --cov-report=term
            else
              echo "ℹ️ No tests directory found"
            fi
          fi
        continue-on-error: true

  html-validation:
    name: HTML Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install HTML validator
        run: |
          npm install -g html-validate

      - name: Validate HTML files in theme directory
        run: |
          # Find all HTML files and validate them
          set -e
          echo "Validating HTML files in theme/ directory..."
          html-validate "theme/**/*.html" --formatter stylish

      - name: Validate compiled HTML files
        run: |
          if [ -d theme/compiled ]; then
            echo "Validating compiled HTML files..."
            set -e
            html-validate "theme/compiled/**/*.html" --formatter stylish
          else
            echo "ℹ️ No compiled directory found, skipping"
          fi

      - name: Check for common HTML issues
        run: |
          echo "Checking for common HTML issues..."

          # Check for missing doctype
          find theme/ -name "*.html" -type f -exec grep -L "<!DOCTYPE" {} \; | while read file; do
            echo "⚠️  Missing DOCTYPE in: $file"
          done

          # Check for inline styles (could be too strict for this project)
          find theme/ -name "*.html" -type f -exec grep -l "style=" {} \; | while read file; do
            count=$(grep -o "style=" "$file" | wc -l)
            echo "ℹ️  Found $count inline styles in: $file"
          done

  javascript-validation:
    name: JavaScript Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ESLint
        run: |
          npm install -g eslint

      - name: Validate JavaScript files
        run: |
          # Find all JS files and check for syntax errors
          set -e
          echo "Validating JavaScript syntax..."
          for file in $(find theme/ -name "*.js" -type f); do
            echo "Checking: $file"
            node --check "$file"
          done
          echo "✅ All JavaScript files are valid"

      - name: Basic ESLint check
        run: |
          find theme/ -name "*.js" -type f | while read file; do
            echo "Linting: $file"
            eslint "$file" --no-eslintrc --parser-options=ecmaVersion:2022 --env es6:true --env browser:true || echo "⚠️ Linting issues in: $file (non-blocking)"
          done
        continue-on-error: true

  build-test:
    name: Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make build script executable
        run: chmod +x build.sh

      - name: Run build script
        run: |
          cd theme
          bash ../build.sh

      - name: Verify compiled files exist
        run: |
          if [ ! -d theme/compiled ]; then
            echo "❌ Compiled directory not created!"
            exit 1
          fi

          file_count=$(find theme/compiled -name "*.html" -type f | wc -l)
          echo "✅ Found $file_count compiled HTML files"

          if [ $file_count -eq 0 ]; then
            echo "❌ No compiled files generated!"
            exit 1
          fi

      - name: Upload compiled artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-wallpapers
          path: theme/compiled/
          retention-days: 7

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [python-validation, html-validation, javascript-validation, build-test]
    if: always()

    steps:
      - name: Check validation results
        run: |
          echo "## Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Python Validation: ${{ needs.python-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Validation: ${{ needs.html-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript Validation: ${{ needs.javascript-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Test: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
