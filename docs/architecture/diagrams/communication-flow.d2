direction: down

# Global style - black text for readability
style: {
  font-color: "#000000"
}

title: {
  label: Communication Flow - Complete System Sequences
  near: top-center
  shape: text
  style: {
    font-size: 26
    bold: true
    fill: "#000000"
  }
}

note: {
  label: |md
    **Two Usage Modes:**
    ‚Ä¢ **Single-File (Hidamari):** Standalone wallpaper-*.html with embedded CSS/JS
    ‚Ä¢ **Multi-File (Browser):** Dynamic background.html loading external files + API
  |
  near: top-center
  shape: text
  style: {
    font-size: 14
    fill: "#fff3e0"
    stroke: "#e65100"
    stroke-width: 2
  }
}

# ============================================================================
# SEQUENCE 1: INSTALLATION & SETUP
# ============================================================================
sequence1: Installation & Setup {
  shape: rectangle
  style.fill: "#e8f5e9"
  style.stroke: "#2e7d32"
  style.stroke-width: 3

  s1_title: {
    shape: text
    label: "üì¶ SEQUENCE 1: Installation & Setup"
    style.font-size: 18
    style.bold: true
  }

  s1_user: User {
    shape: person
    style.fill: "#a5d6a7"
  }

  s1_installer: install.sh {
    shape: stored_data
    style.fill: "#c8e6c9"
  }

  s1_systemd: systemd {
    shape: hexagon
    style.fill: "#81c784"
  }

  s1_filesystem: ~/WallpagesThemes/ {
    shape: cylinder
    style.fill: "#66bb6a"
  }

  s1_api: Flask API {
    shape: stored_data
    style.fill: "#4caf50"
  }

  # Installation flow
  s1_user -> s1_installer: 1. Run ./install.sh {
    style.stroke: "#2e7d32"
    style.stroke-width: 2
  }

  s1_installer -> s1_filesystem: 2. Create directories\n(base, config, 12 themes) {
    style.stroke: "#388e3c"
    style.stroke-width: 2
  }

  s1_installer -> s1_filesystem: 3. Copy template files\n(HTML, CSS, JS) {
    style.stroke: "#388e3c"
    style.stroke-width: 2
  }

  s1_installer -> s1_filesystem: 4. Deploy theme files\n(12 themes √ó 3 files each) {
    style.stroke: "#388e3c"
    style.stroke-width: 2
  }

  s1_installer -> s1_systemd: 5. Install systemd service\nweb-wallpaper-api.service {
    style.stroke: "#43a047"
    style.stroke-width: 2
  }

  s1_systemd -> s1_api: 6. Start Flask API\n(port 5000) {
    style.stroke: "#4caf50"
    style.stroke-width: 2
    style.animated: true
  }

  s1_installer -> s1_user: 7. Installation complete! {
    style.stroke: "#2e7d32"
    style.stroke-width: 2
  }
}

# ============================================================================
# SEQUENCE 2: BUILD PROCESS
# ============================================================================
sequence2: Build Process {
  shape: rectangle
  style.fill: "#fce4ec"
  style.stroke: "#c2185b"
  style.stroke-width: 3

  s2_title: {
    shape: text
    label: "üî® SEQUENCE 2: Build Process"
    style.font-size: 18
    style.bold: true
  }

  s2_user: Developer {
    shape: person
    style.fill: "#f8bbd0"
  }

  s2_build: build.sh {
    shape: stored_data
    style.fill: "#f48fb1"
  }

  s2_base: base/ templates {
    shape: rectangle
    style.fill: "#f06292"
  }

  s2_config: config/ {
    shape: cylinder
    style.fill: "#ec407a"
  }

  s2_themes: 12 theme/ folders {
    shape: rectangle
    style.fill: "#e91e63"
  }

  s2_output: wallpaper-*.html {
    shape: document
    style.fill: "#ffffff"
    style.stroke: "#c2185b"
  }

  # Build flow
  s2_user -> s2_build: 1. Run ./build.sh {
    style.stroke: "#c2185b"
    style.stroke-width: 2
  }

  s2_build -> s2_base: 2. Read background.html\ntemplate.css, template.js\nbackground-manager.js {
    style.stroke: "#d81b60"
    style.stroke-width: 2
  }

  s2_build -> s2_config: 3. Read config.json\n(default theme settings) {
    style.stroke: "#d81b60"
    style.stroke-width: 2
  }

  s2_build -> s2_themes: 4. For each theme:\nRead theme.json\nRead background.js {
    style.stroke: "#d81b60"
    style.stroke-width: 2
  }

  s2_build -> s2_output: 5. Generate single HTML file:\n‚Ä¢ Inline CSS\n‚Ä¢ Embed all JS\n‚Ä¢ Embed theme data\n‚Ä¢ No external deps {
    style.stroke: "#ad1457"
    style.stroke-width: 3
  }

  s2_output -> s2_user: 6. 12 standalone files ready\nfor Hidamari deployment {
    style.stroke: "#c2185b"
    style.stroke-width: 2
  }
}

# ============================================================================
# SEQUENCE 3A: HIDAMARI - SINGLE FILE WALLPAPER (STANDALONE)
# ============================================================================
sequence3a: Hidamari Single-File Mode {
  shape: rectangle
  style.fill: "#e1f5fe"
  style.stroke: "#0277bd"
  style.stroke-width: 3

  s3a_title: {
    shape: text
    label: "üöÄ SEQUENCE 3A: Hidamari - Single HTML File (Standalone)"
    style.font-size: 18
    style.bold: true
  }

  s3a_user: User {
    shape: person
    style.fill: "#b3e5fc"
  }

  s3a_hidamari: Hidamari {
    shape: rectangle
    style.fill: "#81d4fa"
  }

  s3a_html: wallpaper-<theme>.html {
    shape: page
    style.fill: "#ffffff"
    style.stroke: "#0277bd"
    label: "Single HTML file\n‚Ä¢ CSS inlined\n‚Ä¢ JS embedded\n‚Ä¢ Theme data embedded\n‚Ä¢ No external files"
  }

  s3a_canvas: Canvas 2D {
    shape: rectangle
    style.fill: "#039be5"
  }

  # Init flow
  s3a_user -> s3a_hidamari: 1. Sets wallpaper\nwallpaper-<theme>.html {
    style.stroke: "#0277bd"
    style.stroke-width: 2
  }

  s3a_hidamari -> s3a_html: 2. Loads single HTML file {
    style.stroke: "#0288d1"
    style.stroke-width: 2
  }

  s3a_html -> s3a_canvas: 3. Executes embedded JS\nInitializes Canvas 2D\nStarts animation loop {
    style.stroke: "#0277bd"
    style.stroke-width: 3
    style.animated: true
    label: "All code & data embedded\nNo external dependencies"
  }

  s3a_canvas -> s3a_user: 4. Wallpaper ready!\n(No API, no file loading) {
    style.stroke: "#0277bd"
    style.stroke-width: 2
  }
}

# ============================================================================
# SEQUENCE 3B: BROWSER - MULTI-FILE MODE (WITH API)
# ============================================================================
sequence3b: Browser Multi-File Mode {
  shape: rectangle
  style.fill: "#fff9c4"
  style.stroke: "#f57f17"
  style.stroke-width: 3

  s3b_title: {
    shape: text
    label: "üåê SEQUENCE 3B: Browser - Multi-File (Dynamic with API)"
    style.font-size: 18
    style.bold: true
  }

  s3b_user: User {
    shape: person
    style.fill: "#fff59d"
  }

  s3b_browser: Browser {
    shape: rectangle
    style.fill: "#ffee58"
  }

  s3b_html: background.html {
    shape: page
    style.fill: "#ffffff"
    style.stroke: "#f57f17"
  }

  s3b_template: template.js {
    shape: stored_data
    style.fill: "#ffeb3b"
  }

  s3b_config: config.json {
    shape: cylinder
    style.fill: "#fdd835"
  }

  s3b_theme: Theme Files {
    shape: rectangle
    style.fill: "#fbc02d"
  }

  s3b_bgmgr: background-manager.js {
    shape: stored_data
    style.fill: "#f9a825"
  }

  s3b_canvas: Canvas 2D {
    shape: rectangle
    style.fill: "#f57f17"
  }

  # Init flow
  s3b_user -> s3b_browser: 1. Opens background.html {
    style.stroke: "#f57f17"
    style.stroke-width: 2
  }

  s3b_browser -> s3b_html: 2. Loads HTML {
    style.stroke: "#ef6c00"
    style.stroke-width: 2
  }

  s3b_html -> s3b_template: 3. Loads external template.js {
    style.stroke: "#ef6c00"
    style.stroke-width: 2
  }

  s3b_template -> s3b_config: 4. Fetches config.json\n(which theme to use) {
    style.stroke: "#e65100"
    style.stroke-width: 2
  }

  s3b_config -> s3b_template: 5. Returns active theme name {
    style.stroke: "#e65100"
    style.stroke-width: 2
  }

  s3b_template -> s3b_theme: 6. Loads theme.json\n(colors, settings) {
    style.stroke: "#ef6c00"
    style.stroke-width: 2
  }

  s3b_template -> s3b_bgmgr: 7. Loads background-manager.js {
    style.stroke: "#ef6c00"
    style.stroke-width: 2
  }

  s3b_bgmgr -> s3b_theme: 8. Dynamically loads\ntheme/*/background.js {
    style.stroke: "#e65100"
    style.stroke-width: 2
  }

  s3b_bgmgr -> s3b_canvas: 9. Initializes Canvas 2D\nStarts animation loop {
    style.stroke: "#f57f17"
    style.stroke-width: 3
    style.animated: true
  }

  s3b_template -> s3b_user: 10. Wallpaper ready!\n(Can connect to API) {
    style.stroke: "#f57f17"
    style.stroke-width: 2
  }
}

# ============================================================================
# SEQUENCE 4: API POLLING (EVERY 5 SECONDS)
# ============================================================================
sequence4: API Polling Loop {
  shape: rectangle
  style.fill: "#fff3e0"
  style.stroke: "#e65100"
  style.stroke-width: 3

  s4_title: {
    shape: text
    label: "üîÑ SEQUENCE 4: API Polling (every 5s)"
    style.font-size: 18
    style.bold: true
  }

  s4_template: template.js {
    shape: stored_data
    style.fill: "#ffe0b2"
  }

  s4_flask: Flask API {
    shape: stored_data
    style.fill: "#ffcc80"
  }

  s4_psutil: psutil library {
    shape: package
    style.fill: "#ffb74d"
  }

  s4_kernel: Linux Kernel {
    shape: hexagon
    style.fill: "#ffa726"
  }

  s4_panels: UI Panels {
    shape: rectangle
    style.fill: "#ff9800"
  }

  # Polling flow
  s4_template -> s4_flask: 1. HTTP GET /api/stats {
    style.stroke: "#e65100"
    style.stroke-width: 3
    style.animated: true
    label: "Every 5 seconds"
  }

  s4_flask -> s4_psutil: 2. Query all metrics:\ncpu_percent()\nvirtual_memory()\ndisk_usage()\nnet_io_counters() {
    style.stroke: "#f57c00"
    style.stroke-width: 2
  }

  s4_psutil -> s4_kernel: 3. System calls\n/proc/* filesystem {
    style.stroke: "#ef6c00"
    style.stroke-width: 2
  }

  s4_kernel -> s4_psutil: 4. Hardware state {
    style.stroke: "#ef6c00"
    style.stroke-width: 2
  }

  s4_psutil -> s4_flask: 5. Returns metrics {
    style.stroke: "#f57c00"
    style.stroke-width: 2
  }

  s4_flask -> s4_template: 6. JSON response\nwith all metrics {
    style.stroke: "#e65100"
    style.stroke-width: 3
    style.animated: true
  }

  s4_template -> s4_panels: 7. Updates UI panels\n(CPU, RAM, Disk, Network) {
    style.stroke: "#ff6f00"
    style.stroke-width: 2
  }

  s4_panels -> s4_template: 8. Wait 5 seconds...\nRepeat! {
    style.stroke: "#e65100"
    style.stroke-width: 2
    style.stroke-dash: 5
    style.animated: true
  }
}

# ============================================================================
# SEQUENCE 5: THEME SWITCHING
# ============================================================================
sequence5: Theme Switching {
  shape: rectangle
  style.fill: "#f3e5f5"
  style.stroke: "#6a1b9a"
  style.stroke-width: 3

  s5_title: {
    shape: text
    label: "üé® SEQUENCE 5: Theme Switching"
    style.font-size: 18
    style.bold: true
  }

  s5_user: User {
    shape: person
    style.fill: "#e1bee7"
  }

  s5_config: config.json {
    shape: cylinder
    style.fill: "#ffeb3b"
    style.stroke: "#f57f17"
  }

  s5_template: template.js {
    shape: stored_data
    style.fill: "#ce93d8"
  }

  s5_newtheme: New Theme Files {
    shape: rectangle
    style.fill: "#ba68c8"
  }

  s5_bgmgr: background-manager.js {
    shape: stored_data
    style.fill: "#ab47bc"
  }

  s5_oldcanvas: Old Canvas {
    shape: rectangle
    style.fill: "#9c27b0"
    style.stroke-dash: 3
  }

  s5_newcanvas: New Canvas {
    shape: rectangle
    style.fill: "#8e24aa"
  }

  s5_openbar: OpenBar Extension {
    shape: rectangle
    style.fill: "#7b1fa2"
  }

  # Theme switch flow
  s5_user -> s5_config: 1. Edits config.json\nChanges "activeTheme" {
    style.stroke: "#f57f17"
    style.stroke-width: 2
  }

  s5_user -> s5_template: 2. Reloads wallpaper\n(F5 or Hidamari refresh) {
    style.stroke: "#6a1b9a"
    style.stroke-width: 2
  }

  s5_template -> s5_config: 3. Reads new config {
    style.stroke: "#f57f17"
    style.stroke-width: 2
  }

  s5_template -> s5_newtheme: 4. Loads new theme.json\nand background.js {
    style.stroke: "#8e24aa"
    style.stroke-width: 2
  }

  s5_template -> s5_bgmgr: 5. Stops old animation {
    style.stroke: "#9c27b0"
    style.stroke-width: 2
  }

  s5_bgmgr -> s5_oldcanvas: 6. Destroys old canvas {
    style.stroke: "#9c27b0"
    style.stroke-dash: 3
  }

  s5_bgmgr -> s5_newcanvas: 7. Creates new canvas\nStarts new animation {
    style.stroke: "#7b1fa2"
    style.stroke-width: 3
    style.animated: true
  }

  s5_user -> s5_openbar: 8. (Optional) Import new\nopenbar-theme-config {
    style.stroke: "#4a148c"
    style.stroke-width: 2
    style.stroke-dash: 3
  }

  s5_newcanvas -> s5_user: 9. New theme active! {
    style.stroke: "#6a1b9a"
    style.stroke-width: 2
  }
}

# ============================================================================
# SEQUENCE 6: ERROR HANDLING & FALLBACK
# ============================================================================
sequence6: Error Handling {
  shape: rectangle
  style.fill: "#ffebee"
  style.stroke: "#c62828"
  style.stroke-width: 3

  s6_title: {
    shape: text
    label: "‚ö†Ô∏è SEQUENCE 6: Error Handling & Fallback"
    style.font-size: 18
    style.bold: true
  }

  s6_template: template.js {
    shape: stored_data
    style.fill: "#ffcdd2"
  }

  s6_flask: Flask API {
    shape: stored_data
    style.fill: "#ef9a9a"
    style.stroke-dash: 3
  }

  s6_panels: UI Panels {
    shape: rectangle
    style.fill: "#e57373"
  }

  s6_canvas: Canvas Animation {
    shape: rectangle
    style.fill: "#ef5350"
  }

  # Error flow
  s6_template -> s6_flask: 1. HTTP GET /api/stats {
    style.stroke: "#c62828"
    style.stroke-width: 2
  }

  s6_flask -> s6_template: 2. ‚ùå Connection refused\nTimeout / Network error {
    style.stroke: "#d32f2f"
    style.stroke-width: 3
    style.stroke-dash: 3
  }

  s6_template -> s6_template: 3. Catch error\nEnter fallback mode {
    style.stroke: "#e53935"
    style.stroke-width: 2
  }

  s6_template -> s6_panels: 4. Display "API Unavailable"\nShow placeholder text {
    style.stroke: "#f44336"
    style.stroke-width: 2
  }

  s6_template -> s6_canvas: 5. Animation continues\nindependently {
    style.stroke: "#4caf50"
    style.stroke-width: 2
    style.animated: true
  }

  s6_template -> s6_flask: 6. Keep retrying every 5s\nAuto-recovery when API returns {
    style.stroke: "#c62828"
    style.stroke-width: 2
    style.stroke-dash: 5
  }
}

# ============================================================================
# LEGEND
# ============================================================================
legend: {
  shape: rectangle
  near: bottom-center
  style.fill: "#f5f5f5"
  style.stroke: "#424242"
  style.stroke-width: 2

  label: |md
    **Complete System Sequences:**

    üü¢ **Sequence 1:** Installation & Setup - Deploy files, install systemd service, start API
    üî¥ **Sequence 2:** Build Process - Compile 12 themes into standalone HTML files
    üîµ **Sequence 3:** Wallpaper Initialization - Load config, theme, start animation
    üü† **Sequence 4:** API Polling - Fetch system metrics every 5 seconds (continuous)
    üü£ **Sequence 5:** Theme Switching - Change themes at runtime, update OpenBar
    ‚ö†Ô∏è **Sequence 6:** Error Handling - Graceful fallback when API unavailable

    **Animation Types:** Solid lines = synchronous, Dashed lines = optional/async
  |
}
